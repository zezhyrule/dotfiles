$(function(){function t(e){var t=$(e.target),r=t.parents(".entry"),i=t.attr("href"),s=r.find(".entry-title").text();n(t,i,s)}function n(e,t,n){var r=e.hasClass("unread");if(!r){var i={id:"greader",action:"addURL",url:t,title:n};sendMessage(i,function(t){t.status==="success"&&e.addClass("unread"),window.thePKT_BM.handleMessageResponse(t)})}}function r(){$("#entries").bind("DOMNodeInserted",function(e){s(e)}).find(".entry").each(function(e,t){i($(t),!0)})}function i(n,r){var i,s,o,u,a,f=[".entry-icons"];if(n.hasClass("ril_marked")){e&&console.log("Entry has already been marked as inserted with icon.");return}if(n[0].firstChild===null){e&&console.log("Entry has no children and will be ignored. Probably an .entry in the expanded display mode.");return}e&&console.log("Inserting icon into newly inserted entry..."),i=n.find(".entry-title-link"),i.length===0&&(i=n.find(".entry-original")),e&&console.log("find('.entry-title-link') = "+i.html()),i.length>0?(s=i[0].href,e&&console.log("Found URL="+s)):e&&console.log("Could not find entryLink with an href, in the entry: '"+n.html()+"'");for(o=0;o<f.length;++o){u=n.find(f[o]);if(u.length===1&&u.css("display")!=="none")break;u=null}e&&console.log("insertInsideElement = "+u.html());if(!u)return;a=$('<div class="ril-icon">').attr("href",s).appendTo(u),a.hasClass("clickable")||(a.bind("click",function(e){t(e),e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0}),a.addClass("clickable")),n.addClass("ril_marked")}function s(t){e&&console.log("DOMNodeInserted fired");var n=$(t.target);n.hasClass("entry")?(e&&console.log("Inserted node has class 'entry'"),i(n)):n.hasClass("entry-container")&&(e&&console.log("Inserted node has class 'entry-container'"),i(n))}function u(){o||(o=!0,document.body.className=document.body.className+" PKT_ENABLED",r())}if(isSafari()&&window.top!=window)return;var e=!1,o=!1;sendMessage({action:"getSetting",key:"greader"},function(e){(e.value==="true"||e.value===!0)&&u()}),addMessageListener(function(e,t,r){if(e.action==="settingChanged")e.key==="greader"&&(e.value==="true"||e.value===!0)&&u();else if(e.action==="addOpenGoogleReaderArticle"){injectScript(function(){var e=window.getPermalink();if(e){var t;t=document.createElement("p"),t.id="RIL_open_article_url",t.style.display="none",t.innerHTML=e.url,document.getElementsByTagName("body")[0].appendChild(t),t=document.createElement("p"),t.id="RIL_open_article_title",t.style.display="none",t.innerHTML=e.title,document.getElementsByTagName("body")[0].appendChild(t)}});var i=$("#RIL_open_article_url").html(),s=$("#RIL_open_article_title").html();if(i!==null&&s!==null){$("#RIL_open_article_url").remove(),$("#RIL_open_article_title").remove();var o=$(".expanded").find(".ril-icon");n(o,i,s)}}})});